name: Fetch Stream URL

on:
  workflow_dispatch:
    inputs:
      url:
        description: "The URL to scrape for m3u8 links (override default)"
        required: true
        default: "https://news.abplive.com/live-tv"
      max_wait:
        description: "Max seconds the script should wait for m3u8 (optional)"
        required: false
        default: "15"

jobs:
  fetch:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Chromium + Chromedriver
        run: |
          sudo apt-get update -y
          sudo apt-get install -y chromium chromium-driver

          echo "Chromium version:"
          chromium --version || true
          chromedriver --version || true

          echo "CHROMEDRIVER_PATH=$(which chromedriver)" >> $GITHUB_ENV

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install selenium webdriver-manager
          fi

      - name: Run Selenium script (ðŸŸ¢ CLICK TO VIEW RESULTS)
        env:
          TARGET_URL: ${{ github.event.inputs.url }}
          MAX_WAIT_SECONDS: ${{ github.event.inputs.max_wait }}
          CHROMEDRIVER_PATH: ${{ env.CHROMEDRIVER_PATH }}
        run: |
          echo "Running with URL=${TARGET_URL}"
          echo "MAX_WAIT_SECONDS=${MAX_WAIT_SECONDS}"
          python fetch_stream.py 2>&1 | tee fetch_stream_output.txt

      - name: Upload run log
        uses: actions/upload-artifact@v4
        with:
          name: fetch-stream-log
          path: fetch_stream_output.txt

      - name: Commit m3u8.json to repo
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          ls -la
          git add m3u8.json
          git status

          git commit -m "auto: update m3u8.json" || echo "No changes to commit"
          git push
